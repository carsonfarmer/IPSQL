# How to import CSV files into IPSQL

This documentation uses the open data CSV file for the ["Roots of Imperial Trade."](https://www.wnvermeulen.com/empires/)

## Importing

You don't *just* import a CSV file into IPSQL. The import command processes the CSV into blocks
which it can then serve to the network, write to storage, export to block archive formats, export
a diff of the new data as compared to a input store, and even offer in a REPL for testing.

CSV imports are always written as regular SQL tables (not DAG tables) with column types inferred from
the input data and all columns nullable.

```
ipsql import

Import CSV files

Commands:
  bin.js import export <input> <output>     Export blocks
  bin.js import serve <input> [port] [host  Serve the imported database
  ]
  bin.js import repl <input>                Start REPL for imported db

Options:
  --help     Show help                                                 [boolean]
  --version  Show version number                                       [boolean]
```

## Determinism

Importing a CSV into IPSQL will generate a deterministic merkle graph. Importing
the same CSV file on two machines is guaranteed to produce the same database.

If modification are made to the CSV file the graph generated will de-duplicate
parts of the graph with the prior import. This means that whether a database
is mutated with SQL or simply re-imported as a CSV file, the hash of the database
is the same and only the difference between the databases will need to be replicated.

This makes database diffing, replication, and offline behavior similar to `git`.

## Import and Serve

If you want to expose the database you've just imported on a TCP port
you can use this option. IPSQL clients can now query the database remotely.

Note: the protocol IPSQL currently uses is a custom TCP protocol that will eventually
be replaced by a better p2p protocol.

```
$ ipsql import serve empire.csv
importing...
CREATE TABLE `empires.csv` (`empire` VARCHAR(30), `empire_start` INTEGER, `empire_end` INTEGER, `god` INTEGER, `king` INTEGER, `coin` INTEGER, `trade` VARCHAR(4), `country_name` VARCHAR(32), `country_iso` VARCHAR(3), `geo` VARCHAR(8), `begin` INTEGER, `end` INTEGER, `capital` INTEGER)
tcp://45.14.71.183:42597/bafyreigdp3e2kkovjpky2sy7nq3qhwrkifk7a2ve7gk7zgvpyzmncwiwoa
```

The generated SQL for `CREATE` is printed so that you can see the schema.

The last line is a url you can use in the `ipsql` cli to query this database remotely.

```
$ ipsql query tcp://45.14.71.183:42597/bafyreigdp3e2kkovjpky2sy7nq3qhwrkifk7a2ve7gk7zgvpyzmncwiwoa \
  'SELECT empire from `empires.csv` WHERE country_name = "Egypt"'
"Achaemenid Empire"
"Ayyubid Dynasty"
"British Empire"
"Byzantine Empire"
"Egyptian Empire"
"Fatimid Caliphate"
"Great Seljuq Empire"
"Macedonian Empire"
"Mamluk Sultanate"
"NeoAssyrian Empire"
"NeoBabylonian Empire"
"Ottoman Empire"
"Palmyrene Empire"
"Ptolemaic Empire"
"Rashidun Caliphate"
"Roman Empire"
"Sassanid Dynasty"
"Umayyad Caliphate"
"Kingdom of Kush "
"Abbasid Empire"
"Nabataean Kingdom "
```

## Import and REPL

You can also start the REPL to inspect and query the imported database.

```
$ ipsql import repl empires.csv
CREATE TABLE `empires.csv` (`empire` VARCHAR(30), `empire_start` INTEGER, `empire_end` INTEGER, `god` INTEGER, `king` INTEGER, `coin` INTEGER, `trade` VARCHAR(4), `country_name` VARCHAR(32), `country_iso` VARCHAR(3), `geo` VARCHAR(8), `begin` INTEGER, `end` INTEGER, `capital` INTEGER)
> query 'SELECT empire from `empires.csv` WHERE country_name = "Egypt"'
[
  [ 'Achaemenid Empire' ],
  [ 'Ayyubid Dynasty' ],
  [ 'British Empire' ],
  [ 'Byzantine Empire' ],
  [ 'Egyptian Empire' ],
  [ 'Fatimid Caliphate' ],
  [ 'Great Seljuq Empire' ],
  [ 'Macedonian Empire' ],
  [ 'Mamluk Sultanate' ],
  [ 'NeoAssyrian Empire' ],
  [ 'NeoBabylonian Empire' ],
  [ 'Ottoman Empire' ],
  [ 'Palmyrene Empire' ],
  [ 'Ptolemaic Empire' ],
  [ 'Rashidun Caliphate' ],
  [ 'Roman Empire' ],
  [ 'Sassanid Dynasty' ],
  [ 'Umayyad Caliphate' ],
  [ 'Kingdom of Kush ' ],
  [ 'Abbasid Empire' ],
  [ 'Nabataean Kingdom ' ]
]
>
```

## Import and Export

The `import export` command will write out the database that was generated by the importer.

```
ipsql import repl empires.csv output.car
```

The extension of the output file determines what the export format is. Right now, only `.car` is
supported, but eventually other block stores and archive formats will be added.

`.car` files can be imported into IPFS for distribution and can also be stored in Filecoin.

You can now run queries against this file directly with the `query` command.

```
ipsql query output.car 'SELECT empire from `empires.csv` WHERE country_name = "Egypt"'
"Achaemenid Empire"
"Ayyubid Dynasty"
"British Empire"
"Byzantine Empire"
"Egyptian Empire"
"Fatimid Caliphate"
"Great Seljuq Empire"
"Macedonian Empire"
"Mamluk Sultanate"
"NeoAssyrian Empire"
"NeoBabylonian Empire"
"Ottoman Empire"
"Palmyrene Empire"
"Ptolemaic Empire"
"Rashidun Caliphate"
"Roman Empire"
"Sassanid Dynasty"
"Umayyad Caliphate"
"Kingdom of Kush "
"Abbasid Empire"
"Nabataean Kingdom "
```

You can also export **only the data needed to complete a specific SQL query**.

```
ipsql import export empires.csv egypt-empires.car --query='SELECT empire from `empires.csv` WHERE country_name = "Egypt"'
```

This produces a `.car` file that is less than 10% the size of the full database but can still satisfy
the given query.

```
ipsql query egypt-empires.car 'SELECT empire from `empires.csv` WHERE country_name = "Egypt"'
"Achaemenid Empire"
"Ayyubid Dynasty"
"British Empire"
"Byzantine Empire"
"Egyptian Empire"
"Fatimid Caliphate"
"Great Seljuq Empire"
"Macedonian Empire"
"Mamluk Sultanate"
"NeoAssyrian Empire"
"NeoBabylonian Empire"
"Ottoman Empire"
"Palmyrene Empire"
"Ptolemaic Empire"
"Rashidun Caliphate"
"Roman Empire"
"Sassanid Dynasty"
"Umayyad Caliphate"
"Kingdom of Kush "
"Abbasid Empire"
"Nabataean Kingdom "
```


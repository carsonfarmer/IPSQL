# How to import JSON files into IPSQL

This documentation uses the open data JSON feed for the ["USGS earthquakes."](https://earthquake.usgs.gov) Specifically, we'll use the https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson endpoint.

## Importing

You don't *just* import a JSON file into IPSQL. The import command processes the database into blocks
which it can then serve to the network, write to storage, export to block archive formats, export
a diff of the new data as compared to a input store, and even offer in a REPL for testing.

JSON imports are written as DAG Tables. By default, no column indexes are defined but can be passed
via the command line argument `--columns`.

```
ipsql import

Import CSV and JSON files

Commands:
  bin.js import export <input> <output>     Export blocks
  bin.js import serve <input> [port] [host  Serve the imported database
  ]
  bin.js import repl <input>                Start REPL for imported db

Options:
  --help     Show help                                                 [boolean]
  --version  Show version number                                       [boolean]
```

All import commands accept local files and `http://` and `https://` URLs.

## Determinism

Importing JSON into IPSQL will generate a deterministic merkle graph. Importing
the same JSON on two machines is guaranteed to produce the same database (using the same IPSQL
version).

If modifications are made to the JSON file and it is imported again the newly generated
graph will de-duplicate unmodified database against the prior import even though the importer has
no knowledge of the prior database state it's being compared against. This means that whether a database
is mutated with SQL or simply re-imported as a JSON file, the hash of the database
is the same and only the difference between the databases will need to be replicated.

This makes database diffing, replication, and offline behavior similar to `git`.

## Traversal

Many JSON endpoints return an object that contains a list of entries we'd like to import.
For this we can use the `--traverse` options to tell the importer to traverse into the object
to find the given `path`. All of the examples you see here will include `--traverse=features`
because the USGS data endpoint puts the relevant rows in "features" property.

## Specifying Schema

You can read more about [DAG Tables](./dag-tables.md) to understand how column indexes work.

The following examples will use `--columns=``properties/net`` VARCHAR(256)'`.

## Import and Serve

If you want to expose the database you've just imported on a TCP port
you can use this option. IPSQL clients can now query the database remotely.

Note: the protocol IPSQL currently uses is a custom TCP protocol that will eventually
be replaced by a better p2p protocol.

```
$ ipsql import serve https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson \
--traverse=features --columns='`properties/net` VARCHAR(256)'
importing...
Created all_hour.geojson bafyreidcuiqggpgohqjlsyuo2vinkwc5mrquumx2svobbzijdyg3xn74fe
tcp://35.164.76.184:8000/bafyreidcuiqggpgohqjlsyuo2vinkwc5mrquumx2svobbzijdyg3xn74fe
```

The generated SQL for `CREATE` is printed so that you can see the schema.

The last line is a url you can use in the `ipsql` cli to query this database remotely.

```
$ ipsql query tcp://35.164.76.184:8000/bafyreidcuiqggpgohqjlsyuo2vinkwc5mrquumx2svobbzijdyg3xn74fe \
'SELECT `properties/time`,`properties/place` from `all_hour.geojson` where `properties/net` = "ci"'
1610655211440,"11km SW of Salton City, CA"
1610654126190,"14km NE of Borrego Springs, CA"
```

## Import and REPL

You can also start the REPL to inspect and query the imported database.

```
$ ipsql import repl https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson \
--traverse=features --columns='`properties/net` VARCHAR(256)'
Created all_hour.geojson bafyreihne5gtsugv3xxtvqneef5rrrspqndikdyin5lsshbqu5esyoozqm

> query 'SELECT `properties/time`,`properties/place` from `all_hour.geojson` where `properties/net` = "ci"'
[
  [ 1610655211440, '11km SW of Salton City, CA' ],
  [ 1610654126190, '14km NE of Borrego Springs, CA' ]
]
```

## Import and Export

The `import export` command will write out the database that was generated by the importer.

```
$ ipsql import export https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson output.car
```

The extension of the output file determines what the export format is. Right now, only `.car` is
supported, but eventually other block stores and archive formats will be added.

`.car` files can be imported into IPFS for distribution and can also be stored in Filecoin.

You can now run queries against this file directly with the `query` command.

```
$ ipsql query output.car 'SELECT `properties/time`,`properties/place` from `all_hour.geojson` where `properties/net` = "ci"'
1610655211440,"11km SW of Salton City, CA"
1610654126190,"14km NE of Borrego Springs, CA"
```

You can also export **only the data needed to complete a specific SQL query**.

```
$ ipsql import export https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson ci-only.car \
--query='SELECT `properties/time`,`properties/place` from `all_hour.geojson` where `properties/net` = "ci"'
```

This produces a `.car` file that is less than 10% the size of the full database but can still satisfy
the given query.

```
$ ipsql query ci-only.car 'SELECT `properties/time`,`properties/place` from `all_hour.geojson` where `properties/net` = "ci"'
1610655211440,"11km SW of Salton City, CA"
1610654126190,"14km NE of Borrego Springs, CA"
```

### Encryption

You can encrypt any export using IPSQL's [builtin encryption](./encryption.md).

```
$$ ipsql import export https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_hour.geojson ci-only.car \
--query='SELECT `properties/time`,`properties/place` from `all_hour.geojson` where `properties/net` = "ci"' \
--encrypt=test.key
```

This produces a `.car` file that is less than 10% the size of the full database but can still satisfy
the given query.

```
ipsql query ci-only.car \
'SELECT `properties/time`,`properties/place` from `all_hour.geojson` where `properties/net` = "ci"' \
--decrypt=test.key
1610655211440,"11km SW of Salton City, CA"
1610654126190,"14km NE of Borrego Springs, CA"
```


